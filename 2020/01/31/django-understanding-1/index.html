<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>WSGI - Ctwo&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Ctwo&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Ctwo&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前言 开个新坑，Django 源码学习以及深入理解 Django Web 框架 首先从 WSGI 开始，本篇和 Django 看似无联系，确实很重要的一个部分 Django 的自带服务器是基于 Python 的 wsgiref 模块实现的，所以我们在测试期间往往不需要部署 nginx 之类的，那么想要理解这里，就要从 PEP 对于WSGI规范的定义开始"><meta property="og:type" content="blog"><meta property="og:title" content="WSGI"><meta property="og:url" content="http://cyx0706.github.io/2020/01/31/django-understanding-1/"><meta property="og:site_name" content="Ctwo&#039;s Blog"><meta property="og:description" content="前言 开个新坑，Django 源码学习以及深入理解 Django Web 框架 首先从 WSGI 开始，本篇和 Django 看似无联系，确实很重要的一个部分 Django 的自带服务器是基于 Python 的 wsgiref 模块实现的，所以我们在测试期间往往不需要部署 nginx 之类的，那么想要理解这里，就要从 PEP 对于WSGI规范的定义开始"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://cyx0706.github.io/gallery/thumbnails/django.jpg"><meta property="article:published_time" content="2020-01-31T10:24:06.000Z"><meta property="article:modified_time" content="2020-10-25T01:52:21.053Z"><meta property="article:author" content="Ctwo"><meta property="article:tag" content="Django"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/gallery/thumbnails/django.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://cyx0706.github.io/2020/01/31/django-understanding-1/"},"headline":"WSGI","image":["http://cyx0706.github.io/gallery/thumbnails/django.jpg"],"datePublished":"2020-01-31T10:24:06.000Z","dateModified":"2020-10-25T01:52:21.053Z","author":{"@type":"Person","name":"Ctwo"},"publisher":{"@type":"Organization","name":"Ctwo's Blog","logo":{"@type":"ImageObject","url":"http://cyx0706.github.io/img/logo.svg"}},"description":"前言 开个新坑，Django 源码学习以及深入理解 Django Web 框架 首先从 WSGI 开始，本篇和 Django 看似无联系，确实很重要的一个部分 Django 的自带服务器是基于 Python 的 wsgiref 模块实现的，所以我们在测试期间往往不需要部署 nginx 之类的，那么想要理解这里，就要从 PEP 对于WSGI规范的定义开始"}</script><link rel="canonical" href="http://cyx0706.github.io/2020/01/31/django-understanding-1/"><link rel="alternate" href="/atom.xml" title="Ctwo&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.13.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/railscasts.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Ctwo&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/gallery/thumbnails/django.jpg" alt="WSGI"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-01-31T10:24:06.000Z" title="2020-01-31T10:24:06.000Z">2020-01-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-10-25T01:52:21.053Z" title="2020-10-25T01:52:21.053Z">2020-10-25</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Web-FrameWork/">Web FrameWork</a></span></div></div><h1 class="title is-3 is-size-4-mobile">WSGI</h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul>
<li>开个新坑，Django 源码学习以及深入理解 Django Web 框架</li>
<li>首先从 WSGI 开始，本篇和 Django 看似无联系，确实很重要的一个部分</li>
<li>Django 的自带服务器是基于 Python 的 wsgiref 模块实现的，所以我们在测试期间往往不需要部署 nginx 之类的，那么想要理解这里，就要从 PEP 对于WSGI规范的定义开始<a id="more"></a>
<h1 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h1></li>
</ul>
<p>全名 Python Web Server Gateway Interface</p>
<p><a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0333/">doc</a></p>
<h2 id="理由和目标"><a href="#理由和目标" class="headerlink" title="理由和目标"></a>理由和目标</h2><blockquote>
<p>Python currently boasts a wide variety of web application frameworks, such as Zope, Quixote, Webware, SkunkWeb, PSO, and Twisted Web — to name just a few. This wide variety of choices can be a problem for new Python users, because generally speaking, their choice of web framework will limit their choice of usable web servers, and vice versa.</p>
<p>By contrast, although Java has just as many web application frameworks available, Java’s “servlet” API makes it possible for applications written with any Java web application framework to run in any web server that supports the servlet API.</p>
<p>The availability and widespread use of such an API in web servers for Python — whether those servers are written in Python (e.g. Medusa), embed(嵌入) Python (e.g. mod_python), or invoke Python via a gateway protocol (e.g. CGI, FastCGI, etc.) — would separate choice of framework from choice of web server, freeing users to choose a pairing that suits them, while freeing framework and server developers to focus on their preferred area of specialization.<br>This PEP, therefore, proposes(提出) a simple and universal interface between web servers and web applications or frameworks: the Python Web Server Gateway Interface (WSGI)</p>
</blockquote>
<p>看原文更有味道</p>
<blockquote>
<p>Thus, WSGI must be <strong>easy</strong> to implement, so that an author’s initial investment in the interface can be reasonably low.<br>Again, the goal of WSGI is to facilitate easy interconnection of existing servers and applications or frameworks, not to create a new web framework.<br>it allows for the possibility of an entirely new kind of Python web application framework: one consisting of loosely-coupled WSGI middleware components.</p>
</blockquote>
<p>简单来说就是: enable the use of any framework with any server</p>
<h2 id="OverView"><a href="#OverView" class="headerlink" title="OverView"></a>OverView</h2><h3 id="The-Application-Framework-Side"><a href="#The-Application-Framework-Side" class="headerlink" title="The Application/Framework Side"></a>The Application/Framework Side</h3><blockquote>
<p>The application object is simply a callable object that accepts two arguments. The term “object” <strong>should not</strong> be misconstrued as <strong>requiring an actual object instance</strong>: a function, method, class, or instance with a __call__ method are all acceptable for use as an application object. Application objects must be able to be invoked more than once, as virtually all servers/gateways (other than CGI) will make such repeated requests.</p>
</blockquote>
<p>不一定需要实例，只需要 __call__() 接口来提供调用方法</p>
<p>官方文档给出的样例</p>
<figure class="highlight python"><figcaption><span>sample</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simple_app</span>(<span class="params">environ, start_response</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Simplest possible application object&quot;&quot;&quot;</span></span><br><span class="line">    status = <span class="string">&#x27;200 OK&#x27;</span></span><br><span class="line">    response_headers = [(<span class="string">&#x27;Content-type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)]</span><br><span class="line">    start_response(status, response_headers)</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;Hello world!\n&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppClass</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Produce the same output, but using a class</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    (Note: &#x27;AppClass&#x27; is the &quot;application&quot; here, so calling it</span></span><br><span class="line"><span class="string">    returns an instance of &#x27;AppClass&#x27;, which is then the iterable</span></span><br><span class="line"><span class="string">    return value of the &quot;application callable&quot; as required by</span></span><br><span class="line"><span class="string">    the spec.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If we wanted to use *instances* of &#x27;AppClass&#x27; as application</span></span><br><span class="line"><span class="string">    objects instead, we would have to implement a &#x27;__call__&#x27;</span></span><br><span class="line"><span class="string">    method, which would be invoked to execute the application,</span></span><br><span class="line"><span class="string">    and we would need to create an instance for use by the</span></span><br><span class="line"><span class="string">    server or gateway.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">        self.environ = environ</span><br><span class="line">        self.start = start_response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        status = <span class="string">&#x27;200 OK&#x27;</span></span><br><span class="line">        response_headers = [(<span class="string">&#x27;Content-type&#x27;</span>, <span class="string">&#x27;text/plain&#x27;</span>)]</span><br><span class="line">        self.start(status, response_headers)</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&quot;Hello world!\n&quot;</span>  <span class="comment"># 每被迭代一次就返回hello world?</span></span><br></pre></td></tr></table></figure>
<h3 id="The-Server-Gateway-Side"><a href="#The-Server-Gateway-Side" class="headerlink" title="The Server/Gateway Side"></a>The Server/Gateway Side</h3><blockquote>
<p>The server or gateway invokes the application callable once for each request it receives from an HTTP client, that is directed at the application. To illustrate, here is a simple CGI gateway, implemented as a function taking an application object. Note that this simple example has limited error handling, because by default an uncaught exception will be dumped to sys.stderr and logged by the web server.<br><figure class="highlight python"><figcaption><span>sample</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_with_cgi</span>(<span class="params">application</span>):</span></span><br><span class="line"></span><br><span class="line">    environ = <span class="built_in">dict</span>(os.environ.items())</span><br><span class="line">    environ[<span class="string">&#x27;wsgi.input&#x27;</span>]        = sys.stdin</span><br><span class="line">    environ[<span class="string">&#x27;wsgi.errors&#x27;</span>]       = sys.stderr</span><br><span class="line">    environ[<span class="string">&#x27;wsgi.version&#x27;</span>]      = (<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">    environ[<span class="string">&#x27;wsgi.multithread&#x27;</span>]  = <span class="literal">False</span></span><br><span class="line">    environ[<span class="string">&#x27;wsgi.multiprocess&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">    environ[<span class="string">&#x27;wsgi.run_once&#x27;</span>]     = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> environ.get(<span class="string">&#x27;HTTPS&#x27;</span>, <span class="string">&#x27;off&#x27;</span>) <span class="keyword">in</span> (<span class="string">&#x27;on&#x27;</span>, <span class="string">&#x27;1&#x27;</span>):</span><br><span class="line">        environ[<span class="string">&#x27;wsgi.url_scheme&#x27;</span>] = <span class="string">&#x27;https&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        environ[<span class="string">&#x27;wsgi.url_scheme&#x27;</span>] = <span class="string">&#x27;http&#x27;</span></span><br><span class="line"></span><br><span class="line">    headers_set = []</span><br><span class="line">    headers_sent = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">data</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> headers_set:</span><br><span class="line">            <span class="keyword">raise</span> AssertionError(<span class="string">&quot;write() before start_response()&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> headers_sent:</span><br><span class="line">            <span class="comment"># Before the first output, send the stored headers</span></span><br><span class="line">            <span class="comment"># 自动解包依次赋值给变量</span></span><br><span class="line">            status, response_headers = headers_sent[:] = headers_set</span><br><span class="line">            <span class="comment"># 为啥是 \r\n?</span></span><br><span class="line">            sys.stdout.write(<span class="string">&#x27;Status: %s\r\n&#x27;</span> % status)</span><br><span class="line">            <span class="keyword">for</span> header <span class="keyword">in</span> response_headers:</span><br><span class="line">                sys.stdout.write(<span class="string">&#x27;%s: %s\r\n&#x27;</span> % header)</span><br><span class="line">            sys.stdout.write(<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        sys.stdout.write(data)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_response</span>(<span class="params">status, response_headers, exc_info=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> exc_info:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> headers_sent:</span><br><span class="line">                    <span class="comment"># Re-raise original exception if headers sent</span></span><br><span class="line">                    <span class="keyword">raise</span> exc_info[<span class="number">0</span>], exc_info[<span class="number">1</span>], exc_info[<span class="number">2</span>]</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                exc_info = <span class="literal">None</span>     <span class="comment"># avoid dangling circular ref</span></span><br><span class="line">        <span class="keyword">elif</span> headers_set:</span><br><span class="line">            <span class="keyword">raise</span> AssertionError(<span class="string">&quot;Headers already set!&quot;</span>)</span><br><span class="line">        <span class="comment"># 保持 headers_set id 不变，只将值赋给其</span></span><br><span class="line">        headers_set[:] = [status, response_headers]</span><br><span class="line">        <span class="keyword">return</span> write</span><br><span class="line"></span><br><span class="line">    result = application(environ, start_response)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 把所有返回的结果都写好之后再返回</span></span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">if</span> data:    <span class="comment"># don&#x27;t send headers until body appears</span></span><br><span class="line">                write(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> headers_sent:</span><br><span class="line">            write(<span class="string">&#x27;&#x27;</span>)   <span class="comment"># send headers now if body was empty</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(result, <span class="string">&#x27;close&#x27;</span>):</span><br><span class="line">            result.close()</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h3><p>中间键文档中也有给出的例子，不过这个不在我们这次的讨论范围里，中间键是对我们第一步处理的一个二次处理或者一定的补充。</p>
<blockquote>
<ul>
<li>Routing a request to different application objects based on the target URL, after rewriting the environ accordingly.</li>
<li>Allowing multiple applications or frameworks to run side-by-side in the same process</li>
<li>Load balancing and remote processing, by forwarding requests and responses over a network</li>
<li>Perform content postprocessing, such as applying XSL stylesheets</li>
</ul>
</blockquote>
<h3 id="Specification-Details"><a href="#Specification-Details" class="headerlink" title="Specification Details"></a>Specification Details</h3><ul>
<li>我们的目的起码目前不是自己写一个，无需看详细的细节，前面的都弄明白就行了</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>简单来说，WSGI 定义了服务器程序和 Web 框架直接通信的手段：服务器程序将请求和包装好的环境变量传给 Web 框架的程序，这种传递方法官方文档给出了传递函数指针的方式或者被调用者实现 callable 的接口，也就是 __call__ 方法。例子中使用的是 start_response， 这个函数在服务器类中被定义，在 Web 框架的函数中被调用。结果作为类的一个属性被，当类被加载时，为了获取这个属性，就会去调用 application（框架程序）来处理。以 call 的方式实现的如 Django 的 WSGIHandler，我们会在后面说到。</p>
<h2 id="Python-wsgiref"><a href="#Python-wsgiref" class="headerlink" title="Python wsgiref"></a>Python wsgiref</h2><ul>
<li>wsgiref 是 Python 内置的一个实现 wsgi 的参考，纯 Python 编写，它提供了一个开发和测试的工具，其实现的功能有：<ul>
<li>操作 wsgi 的环境变量</li>
<li>应答头部的处理</li>
<li>实现简单的 HTTP server</li>
<li>简单的对程序端和服务器端校验函数</li>
</ul>
</li>
</ul>
<h3 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h3><p>&gt;</p>
<blockquote>
<p>wsgiref<br>   |— handlers.py&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 负责 wsgi 程序的处理<br>   |— headers.py&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 处理头<br>   |— __init__.py&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #<br>   |— simple_server.py # 简单的 wsgi HTTP 服务器实现<br>   |— util.py&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 帮助函数<br>   |— validate.py&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # wsgi 格式检查和校验</p>
</blockquote>
<p><img src="https://i.loli.net/2020/01/31/8i9u367Oa5EXeLZ.png" alt="结构"></p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ol>
<li>服务器应用程序创建 socket，并监听在特定的端口（往往是80），等待客户端的连接</li>
<li>客户端发送 http 请求</li>
<li>socket server 读取请求的数据，交给 WSGIServer</li>
<li>WSGIServer 首先用继承自 http server 的方法基于 http 的规范解析请求</li>
<li>WSGIServer 把客户端的信息存放在 environ 变量里，然后交给绑定的 handler 处理请求</li>
<li>WSGIRequestHandler 调用继承 HTTPHandler 的方法解析请求，把 method、path 等放在 environ，通过自己的额外函数把服务器端的信息也放到 environ 里</li>
<li>WSGIRequestHandler 调用绑定的 wsgi ServerHandler，把上面包含了服务器信息，客户端信息，将本次请求信息的 environ 传入</li>
<li>wsgi ServerHandler 调用注册的 wsgi app，把 environ 和 start_response 作为参数传递过去</li>
<li>wsgi app 处理后将 reponse header、status、body 回传给 wsgi handler，然后 handler 逐层传递，最后把这些信息通过 socket 发送到客户端，客户端的程序接到应答，解析应答，并把结果打印出来。</li>
</ol>
<h3 id="源码简单解读"><a href="#源码简单解读" class="headerlink" title="源码简单解读"></a>源码简单解读</h3><p>我们可以对 simple_server.py 展开详细的阅读</p>
<figure class="highlight python"><figcaption><span>simple_server.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServerHandler</span>(<span class="params">SimpleHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    server_software = software_version</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.request_handler.log_request(</span><br><span class="line">                self.status.split(<span class="string">&#x27; &#x27;</span>,<span class="number">1</span>)[<span class="number">0</span>], self.bytes_sent</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            SimpleHandler.close(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIServer</span>(<span class="params">HTTPServer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;BaseHTTPServer that implements the Python WSGI protocol&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    application = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">server_bind</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Override server_bind to store the server name.&quot;&quot;&quot;</span></span><br><span class="line">        HTTPServer.server_bind(self)</span><br><span class="line">        self.setup_environ()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup_environ</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Set up base environment</span></span><br><span class="line">        env = self.base_environ = &#123;&#125;</span><br><span class="line">        env[<span class="string">&#x27;SERVER_NAME&#x27;</span>] = self.server_name</span><br><span class="line">        env[<span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span>] = <span class="string">&#x27;CGI/1.1&#x27;</span></span><br><span class="line">        env[<span class="string">&#x27;SERVER_PORT&#x27;</span>] = <span class="built_in">str</span>(self.server_port)</span><br><span class="line">        env[<span class="string">&#x27;REMOTE_HOST&#x27;</span>]=<span class="string">&#x27;&#x27;</span></span><br><span class="line">        env[<span class="string">&#x27;CONTENT_LENGTH&#x27;</span>]=<span class="string">&#x27;&#x27;</span></span><br><span class="line">        env[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_app</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.application</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 绑定 app</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_app</span>(<span class="params">self,application</span>):</span></span><br><span class="line">        self.application = application</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIRequestHandler</span>(<span class="params">BaseHTTPRequestHandler</span>):</span></span><br><span class="line"></span><br><span class="line">    server_version = <span class="string">&quot;WSGIServer/&quot;</span> + __version__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_environ</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 拷贝一份基本的环境变量</span></span><br><span class="line">        env = self.server.base_environ.copy()</span><br><span class="line">        <span class="comment"># 设置服务器的版本，协议</span></span><br><span class="line">        env[<span class="string">&#x27;SERVER_PROTOCOL&#x27;</span>] = self.request_version</span><br><span class="line">        env[<span class="string">&#x27;SERVER_SOFTWARE&#x27;</span>] = self.server_version</span><br><span class="line">        <span class="comment"># 请求方法</span></span><br><span class="line">        env[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] = self.command</span><br><span class="line">        <span class="comment"># 获取请求的 url 中的参数</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;?&#x27;</span> <span class="keyword">in</span> self.path:</span><br><span class="line">            path,query = self.path.split(<span class="string">&#x27;?&#x27;</span>,<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            path,query = self.path,<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        env[<span class="string">&#x27;PATH_INFO&#x27;</span>] = urllib.parse.unquote(path, <span class="string">&#x27;iso-8859-1&#x27;</span>)</span><br><span class="line">        env[<span class="string">&#x27;QUERY_STRING&#x27;</span>] = query</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 这里不是很明白，大概是对于请求的 ip 的获取</span></span><br><span class="line">        host = self.address_string()</span><br><span class="line">        <span class="keyword">if</span> host != self.client_address[<span class="number">0</span>]:</span><br><span class="line">            env[<span class="string">&#x27;REMOTE_HOST&#x27;</span>] = host</span><br><span class="line">        env[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] = self.client_address[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 请求内容</span></span><br><span class="line">        <span class="keyword">if</span> self.headers.get(<span class="string">&#x27;content-type&#x27;</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            env[<span class="string">&#x27;CONTENT_TYPE&#x27;</span>] = self.headers.get_content_type()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            env[<span class="string">&#x27;CONTENT_TYPE&#x27;</span>] = self.headers[<span class="string">&#x27;content-type&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取请求内容字段长</span></span><br><span class="line">        length = self.headers.get(<span class="string">&#x27;content-length&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> length:</span><br><span class="line">            env[<span class="string">&#x27;CONTENT_LENGTH&#x27;</span>] = length</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 除标注定义外的一些额外字段的添加?</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> self.headers.items():</span><br><span class="line">            k=k.replace(<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;_&#x27;</span>).upper(); v=v.strip()</span><br><span class="line">            <span class="keyword">if</span> k <span class="keyword">in</span> env:</span><br><span class="line">                <span class="keyword">continue</span>                    <span class="comment"># skip content length, type,etc.</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;HTTP_&#x27;</span>+k <span class="keyword">in</span> env:</span><br><span class="line">                env[<span class="string">&#x27;HTTP_&#x27;</span>+k] += <span class="string">&#x27;,&#x27;</span>+v     <span class="comment"># comma-separate multiple headers</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                env[<span class="string">&#x27;HTTP_&#x27;</span>+k] = v</span><br><span class="line">        <span class="keyword">return</span> env</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_stderr</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> sys.stderr</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理单次请求</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Handle a single HTTP request&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        self.raw_requestline = self.rfile.readline(<span class="number">65537</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.raw_requestline) &gt; <span class="number">65536</span>:</span><br><span class="line">            self.requestline = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            self.request_version = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            self.command = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            self.send_error(<span class="number">414</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.parse_request(): <span class="comment"># An error code has been sent, just exit</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 请求交给 handler 处理</span></span><br><span class="line">        handler = ServerHandler(</span><br><span class="line">            self.rfile, self.wfile, self.get_stderr(), self.get_environ()</span><br><span class="line">        )</span><br><span class="line">        handler.request_handler = self      <span class="comment"># backpointer for logging</span></span><br><span class="line">        <span class="comment"># 把封装的环境变量交给 ServerHandler，然后由 ServerHandler 调用 wsgi app</span></span><br><span class="line">        handler.run(self.server.get_app())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo_app</span>(<span class="params">environ,start_response</span>):</span></span><br><span class="line">    <span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line">    stdout = StringIO()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello world!&quot;</span>, file=stdout)</span><br><span class="line">    <span class="built_in">print</span>(file=stdout)</span><br><span class="line">    h = <span class="built_in">sorted</span>(environ.items())</span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> h:</span><br><span class="line">        <span class="built_in">print</span>(k,<span class="string">&#x27;=&#x27;</span>,<span class="built_in">repr</span>(v), file=stdout)</span><br><span class="line">    start_response(<span class="string">&quot;200 OK&quot;</span>, [(<span class="string">&#x27;Content-Type&#x27;</span>,<span class="string">&#x27;text/plain; charset=utf-8&#x27;</span>)])</span><br><span class="line">    <span class="keyword">return</span> [stdout.getvalue().encode(<span class="string">&quot;utf-8&quot;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_server</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    host, port, app, server_class=WSGIServer, handler_class=WSGIRequestHandler</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Create a new WSGI server listening on `host` and `port` for `app`&quot;&quot;&quot;</span></span><br><span class="line">    server = server_class((host, port), handler_class)</span><br><span class="line">    server.set_app(app)</span><br><span class="line">    <span class="keyword">return</span> server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> make_server(<span class="string">&#x27;&#x27;</span>, <span class="number">8000</span>, demo_app) <span class="keyword">as</span> httpd:</span><br><span class="line">        sa = httpd.socket.getsockname()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Serving HTTP on&quot;</span>, sa[<span class="number">0</span>], <span class="string">&quot;port&quot;</span>, sa[<span class="number">1</span>], <span class="string">&quot;...&quot;</span>)</span><br><span class="line">        <span class="keyword">import</span> webbrowser</span><br><span class="line">        webbrowser.<span class="built_in">open</span>(<span class="string">&#x27;http://localhost:8000/xyz?abc&#x27;</span>)</span><br><span class="line">        httpd.handle_request()  <span class="comment"># serve one request, then exit</span></span><br></pre></td></tr></table></figure>
<h3 id="简易-demo"><a href="#简易-demo" class="headerlink" title="简易 demo"></a>简易 demo</h3><p>我们可以自己尝试弄一个简易的服务器来玩</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world_app</span>(<span class="params">environ, start_response</span>):</span></span><br><span class="line">    <span class="comment"># environ 是一个包含所有 HTTP 请求信息的 dict 对象</span></span><br><span class="line">    status = <span class="string">&quot;200 OK&quot;</span></span><br><span class="line">    <span class="comment"># HTTP响应的输出都可以通过 start_response() 加上函数返回值作为 Body</span></span><br><span class="line">    headers = [(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;text/html&quot;</span>)]</span><br><span class="line">    start_response(status, headers)</span><br><span class="line">    body = <span class="string">&quot;&lt;h1&gt;hello &#123;&#125;&lt;/h1&gt;&quot;</span>.<span class="built_in">format</span>(environ[<span class="string">&#x27;PATH_INFO&#x27;</span>][<span class="number">1</span>:] <span class="keyword">or</span> <span class="string">&quot;Web&quot;</span>)  <span class="comment"># 去掉第一个斜杠</span></span><br><span class="line">    <span class="keyword">return</span> [body.encode(<span class="string">&quot;utf-8&quot;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># server.py</span></span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> hello_world_app</span><br><span class="line"></span><br><span class="line">httpd = make_server(<span class="string">&#x27;&#x27;</span>, <span class="number">8000</span>, hello_world_app)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Starting server at 8000&quot;</span>)</span><br><span class="line">httpd.serve_forever()</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/01/31/jZQ7GbCcStFz2Ex.png" alt=""><br><img src="https://i.loli.net/2020/01/31/tEDyhkCwYlWo3us.png" alt=""></p>
<h2 id="下集预告"><a href="#下集预告" class="headerlink" title="下集预告?"></a>下集预告?</h2><ul>
<li>Django 中自带的 wsgi的实现</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000013450695">深入理解wsgiref</a></li>
<li><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017805733037760">WSGI接口</a></li>
<li><a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0333/">PEP333</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>WSGI</p><p><a href="http://cyx0706.github.io/2020/01/31/django-understanding-1/">http://cyx0706.github.io/2020/01/31/django-understanding-1/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Ctwo</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2020-01-31</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2020-10-25</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Django/">Django</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/02/02/Linkers-Loaders-3/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">程序员的自我修养—目标文件里有什么</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/01/30/matplotlib-base/"><span class="level-item">matplotlib 入门</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "a5a80e97cdd43bcc64f765b46019748d",
            repo: "cyx0706.github.io",
            owner: "cyx0706",
            clientID: "4d458c0d13a2c2157dbd",
            clientSecret: "99a8159ca4a12d236f888be149168b92808a4e29",
            admin: ["cyx0706"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#WSGI"><span class="level-left"><span class="level-item">2</span><span class="level-item">WSGI</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#理由和目标"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">理由和目标</span></span></a></li><li><a class="level is-mobile" href="#OverView"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">OverView</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#The-Application-Framework-Side"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">The Application/Framework Side</span></span></a></li><li><a class="level is-mobile" href="#The-Server-Gateway-Side"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">The Server/Gateway Side</span></span></a></li><li><a class="level is-mobile" href="#Middleware"><span class="level-left"><span class="level-item">2.2.3</span><span class="level-item">Middleware</span></span></a></li><li><a class="level is-mobile" href="#Specification-Details"><span class="level-left"><span class="level-item">2.2.4</span><span class="level-item">Specification Details</span></span></a></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">2.2.5</span><span class="level-item">总结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Python-wsgiref"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">Python wsgiref</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#代码结构"><span class="level-left"><span class="level-item">2.3.1</span><span class="level-item">代码结构</span></span></a></li><li><a class="level is-mobile" href="#流程"><span class="level-left"><span class="level-item">2.3.2</span><span class="level-item">流程</span></span></a></li><li><a class="level is-mobile" href="#源码简单解读"><span class="level-left"><span class="level-item">2.3.3</span><span class="level-item">源码简单解读</span></span></a></li><li><a class="level is-mobile" href="#简易-demo"><span class="level-left"><span class="level-item">2.3.4</span><span class="level-item">简易 demo</span></span></a></li></ul></li><li><a class="level is-mobile" href="#下集预告"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">下集预告?</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">参考</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Ctwo&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 Ctwo</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>